# 基于时间的校准采样逻辑

本文档描述了ADC按键校准系统的新采样逻辑，从基于样本数量的结束条件改为基于时间的采样机制。

## 新的采样逻辑

### 核心改进

1. **基于时间的采样**：从第一个符合条件的样本出现开始，持续采样1000ms
2. **循环缓冲区**：保存最后100个样本，使用循环缓冲区机制
3. **统一稳定性检查**：采样完成后统一进行稳定性校验和合法性校验
4. **平均值计算**：使用最后100个样本计算平均值作为校准结果

### 详细流程

#### 1. 采样开始条件
- 按键处于校准阶段（TOP_SAMPLING 或 BOTTOM_SAMPLING）
- 收到第一个符合期望值范围的ADC样本
- 设置 `samplingStarted = true` 并记录开始时间

#### 2. 持续采样过程
- 持续接收ADC样本，验证是否在期望值范围内
- 使用循环缓冲区保存最后100个样本
- 更新最小值和最大值
- 检查采样时间是否达到1000ms

#### 3. 采样完成条件
- 采样时间达到1000ms（`SAMPLING_DURATION_MS = 1000`）
- 至少有10个有效样本

#### 4. 稳定性检查
- 检查最大值与最小值的差异是否在稳定性阈值内
- 检查所有样本与第一个样本的差异是否在稳定性阈值内
- 如果稳定性检查失败，重新开始采样

#### 5. 结果计算
- 使用最后100个样本计算平均值
- 保存校准结果并进入下一阶段

## 技术实现

### 数据结构变更

```cpp
struct ButtonCalibrationState {
    // 新增字段
    uint8_t bufferIndex = 0;                    // 缓冲区索引（循环使用）
    uint32_t samplingStartTime = 0;             // 采样开始时间
    bool samplingStarted = false;               // 是否已开始采样
    
    // 修改字段
    std::array<uint16_t, 100> sampleBuffer;    // 采样缓冲区（保存最后100个样本）
    uint8_t sampleCount = 0;                   // 当前采样数量（最大100）
};
```

### 关键常量

```cpp
static constexpr uint8_t MAX_SAMPLES = 100;            // 最大采样数量
static constexpr uint32_t SAMPLING_DURATION_MS = 1000; // 采样持续时间（毫秒）
```

### 核心方法

#### `addSample()`
- 验证采样值是否在期望范围内
- 如果是第一个有效样本，开始采样计时
- 添加样本到循环缓冲区
- 检查采样时间是否完成

#### `startSampling()`
- 设置采样开始标志
- 记录采样开始时间

#### `addSampleToBuffer()`
- 使用循环缓冲区保存样本
- 更新采样计数和最小最大值

#### `checkSamplingTimeComplete()`
- 检查是否已经采样了1000ms

#### `checkSampleStability()`
- 检查样本稳定性（最大值-最小值差异）
- 检查样本间差异

#### `finalizeSampling()`
- 使用最后100个样本计算平均值
- 保存校准结果

## 优势

### 1. 更稳定的采样结果
- 持续采样1000ms，获得更多样本数据
- 减少单次采样误差的影响
- 更好的抗噪声能力

### 2. 更灵活的时间控制
- 用户有充足时间操作按键
- 避免因操作过快导致的采样失败
- 适应不同用户的操作习惯

### 3. 更高效的资源利用
- 循环缓冲区避免内存浪费
- 只保存最后100个样本，减少存储需求
- 统一的稳定性检查，减少重复计算

### 4. 更好的用户体验
- 采样过程更直观（基于时间而非样本数）
- 减少因操作不当导致的重新采样
- 更稳定的校准结果

## 兼容性

- 保持原有的API接口不变
- 保持原有的回调机制
- 保持原有的LED指示逻辑
- 保持原有的Flash存储机制

## 调试信息

新增的调试输出包括：
- 采样开始时间
- 采样持续时间
- 使用的样本数量
- 稳定性检查结果
- 校准完成信息

这些信息有助于调试和监控校准过程。 